name: Build Debug APK

on:
  push:
    branches: [ "main" ]
    paths:
      - 'code/**'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'code/**'
      - '.github/workflows/build-apk.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      
      - name: Install NDK
        run: sdkmanager "ndk;26.1.10909125"

      - name: Build BusyBox
        run: |
          git clone --depth 1 https://github.com/mirror/busybox.git
          cd busybox
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=aarch64-linux-android
          export API=26
          export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export LD=$TOOLCHAIN/bin/ld.lld
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          make distclean
          # Use default config to include coreutils and standard tools
          make defconfig
          
          # Enable static linking
          sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
          
          # Enable Shells
          sed -i 's/# CONFIG_ASH is not set/CONFIG_ASH=y/' .config
          
          # Disable features known to break Android NDK builds (missing headers)
          sed -i 's/CONFIG_FEATURE_UTMP=y/# CONFIG_FEATURE_UTMP is not set/' .config
          sed -i 's/CONFIG_FEATURE_WTMP=y/# CONFIG_FEATURE_WTMP is not set/' .config
          sed -i 's/CONFIG_FEATURE_INETD_RPC=y/# CONFIG_FEATURE_INETD_RPC is not set/' .config
          
          # Disable console-tools and other problematic applets for Android
          sed -i 's/CONFIG_LOADFONT=y/# CONFIG_LOADFONT is not set/' .config
          sed -i 's/CONFIG_SETFONT=y/# CONFIG_SETFONT is not set/' .config
          sed -i 's/CONFIG_HOSTID=y/# CONFIG_HOSTID is not set/' .config
          sed -i 's/CONFIG_LOGNAME=y/# CONFIG_LOGNAME is not set/' .config
          sed -i 's/CONFIG_WHO=y/# CONFIG_WHO is not set/' .config
          sed -i 's/CONFIG_W=y/# CONFIG_W is not set/' .config
          sed -i 's/CONFIG_USERS=y/# CONFIG_USERS is not set/' .config
          sed -i 's/CONFIG_TTY=y/# CONFIG_TTY is not set/' .config
          sed -i 's/CONFIG_SYNC=y/# CONFIG_SYNC is not set/' .config
          
          # Disable hardware acceleration for hashes (causes issues with NDK/Clang on some archs)
          sed -i 's/CONFIG_SHA1_HWACCEL=y/# CONFIG_SHA1_HWACCEL is not set/' .config
          sed -i 's/CONFIG_SHA256_HWACCEL=y/# CONFIG_SHA256_HWACCEL is not set/' .config
          
          # Force cross-compilation variables
          make -j$(nproc) CC="$CC" AR="$AR" LD="$LD"
          
          $STRIP busybox
          mkdir -p ../code/app/src/main/assets/bin
          cp busybox ../code/app/src/main/assets/bin/
          cd ..
          rm -rf busybox

      - name: Accept Android Licenses
        run: yes | sdkmanager --licenses || true

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew
        working-directory: code

      - name: Build with Gradle
        run: ./gradlew assembleDebug --stacktrace
        working-directory: code

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: supernova-debug
          path: code/app/build/outputs/apk/debug/app-debug.apk