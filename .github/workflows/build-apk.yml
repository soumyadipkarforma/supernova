name: Build Debug APK

on:
  push:
    branches: [ "main" ]
    paths:
      - 'code/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'code/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      
      - name: Install NDK
        run: sdkmanager "ndk;26.1.10909125"

      - name: Build BusyBox
        run: |
          git clone --depth 1 https://github.com/mirror/busybox.git
          cd busybox
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=aarch64-linux-android
          export API=26
          export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export LD=$TOOLCHAIN/bin/ld.lld
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          make distclean
          # Start with a minimal config to avoid bloat and build errors
          make allnoconfig
          
          # Enable static linking
          sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
          
          # Enable Shells
          sed -i 's/# CONFIG_ASH is not set/CONFIG_ASH=y/' .config
          sed -i 's/# CONFIG_SH_IS_ASH is not set/CONFIG_SH_IS_ASH=y/' .config
          
          # Enable Core Commands (carefully selected)
          sed -i 's/# CONFIG_LS is not set/CONFIG_LS=y/' .config
          sed -i 's/# CONFIG_CAT is not set/CONFIG_CAT=y/' .config
          sed -i 's/# CONFIG_ECHO is not set/CONFIG_ECHO=y/' .config
          sed -i 's/# CONFIG_CP is not set/CONFIG_CP=y/' .config
          sed -i 's/# CONFIG_MV is not set/CONFIG_MV=y/' .config
          sed -i 's/# CONFIG_RM is not set/CONFIG_RM=y/' .config
          sed -i 's/# CONFIG_MKDIR is not set/CONFIG_MKDIR=y/' .config
          sed -i 's/# CONFIG_CHMOD is not set/CONFIG_CHMOD=y/' .config
          
          # Force cross-compilation variables
          make -j$(nproc) CC="$CC" AR="$AR" LD="$LD"
          
          $STRIP busybox
          mkdir -p ../code/app/src/main/assets/bin
          cp busybox ../code/app/src/main/assets/bin/
          cd ..
          rm -rf busybox

      - name: Accept Android Licenses
        run: yes | sdkmanager --licenses || true

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew
        working-directory: code

      - name: Build with Gradle
        run: ./gradlew assembleDebug --stacktrace
        working-directory: code

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: supernova-debug
          path: code/app/build/outputs/apk/debug/app-debug.apk